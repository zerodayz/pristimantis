---
- name: set bootstrap status to false on all Controllers
  hosts: Controller
  user: heat-admin
  become: true
  tasks:
    - set_fact:
        bootstrap_node: false
        
- name: set the bootstrap status on the first Controller node
  hosts: Controller[0]
  user: heat-admin
  become: true
  tasks:
  - set_fact:
      bootstrap_node: true

- name: cluster unmanage RabbitMQ and HA Proxy
  hosts: Controller
  user: heat-admin
  become: true
  tasks:
  - name: pcs resource disable rabbitmq-clone
    command: "pcs resource disable rabbitmq-clone"
    when: bootstrap_node == true
  - name: pcs resource unmanage rabbitmq-clone
    command: "pcs resource unmanage rabbitmq-clone"
    when: bootstrap_node == true
  - name: pcs resource unmanage haproxy
    command: "pcs resource unmanage haproxy"
    when: bootstrap_node == true

- name: clean up rabbitmq processes
  hosts: Controller
  user: heat-admin
  become: true
  tasks:
  - name: pkill -u rabbitmq
    command: "pkill -u rabbitmq"
  - name: rm -rf /var/lib/rabbitmq/mnesia/*
    command: "rm -rf /var/lib/rabbitmq/mnesia/*"
  - name: rabbitmq-server -detached
    command: "rabbitmq-server -detached"
  - name: rabbitmqctl stop_app
    command: "rabbitmqctl stop_app"
    when: bootstrap_node == false
  - name: rabbitmqctl join_cluster rabbit@controller-0
    command: "rabbitmqctl join_cluster rabbit@controller-0"
    when: bootstrap_node == false
  - name: rabbitmqctl start_app
    command: "rabbitmqctl start_app"
    when: bootstrap_node == false


- name: cluster manage and cleanup RabbitMQ and HA Proxy
  hosts: Controller
  user: heat-admin
  become: true
  tasks:
  - name: pcs resource manage rabbitmq-clone
    command: "pcs resource manage rabbitmq-clone"
    when: bootstrap_node == true
  - name: pcs resource enable rabbitmq-clone
    command: "pcs resource enable rabbitmq-clone"
    when: bootstrap_node == true
  - name: pcs resource manage haproxy
    command: "pcs resource manage haproxy"
    when: bootstrap_node == true
  - name: pcs resource cleanup
    command: "pcs resource cleanup"
    when: bootstrap_node == true
